
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>transactions Â· test search plus plugin</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search-plus/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="upgrade-to-v4.html" />
    
    
    <link rel="prev" href="scopes.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="associations.html">
            
                <a href="associations.html">
            
                    
                    associations
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="getting-started.html">
            
                <a href="getting-started.html">
            
                    
                    getting started
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="hooks.html">
            
                <a href="hooks.html">
            
                    
                    hooks
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="imprint.html">
            
                <a href="imprint.html">
            
                    
                    imprint
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="./">
            
                <a href="./">
            
                    
                    index
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="instances.html">
            
                <a href="instances.html">
            
                    
                    instances
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="legacy.html">
            
                <a href="legacy.html">
            
                    
                    legacy
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="migrations.html">
            
                <a href="migrations.html">
            
                    
                    migrations
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="models-definition.html">
            
                <a href="models-definition.html">
            
                    
                    models definition
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11" data-path="models-usage.html">
            
                <a href="models-usage.html">
            
                    
                    models usage
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12" data-path="querying.html">
            
                <a href="querying.html">
            
                    
                    querying
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13" data-path="raw-queries.html">
            
                <a href="raw-queries.html">
            
                    
                    raw queries
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14" data-path="scopes.html">
            
                <a href="scopes.html">
            
                    
                    scopes
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.15" data-path="transactions.html">
            
                <a href="transactions.html">
            
                    
                    transactions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16" data-path="upgrade-to-v4.html">
            
                <a href="upgrade-to-v4.html">
            
                    
                    upgrade to v4
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17" data-path="usage.html">
            
                <a href="usage.html">
            
                    
                    usage
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.18" data-path="whos-using.html">
            
                <a href="whos-using.html">
            
                    
                    whos using
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >transactions</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div class="search-plus" id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="transactions">Transactions</h1>
<p>Sequelize supports two ways of using transactions:</p>
<ul>
<li>One which will automatically commit or rollback the transaction based on the result of a promise chain and, (if enabled) pass the transaction to all calls within the callback</li>
<li>And one which leaves committing, rolling back and passing the transaction to the user.</li>
</ul>
<p>The key difference is that the managed transaction uses a callback that expects a promise to be returned to it while the unmanaged transaction returns a promise.</p>
<h2 id="managed-transaction-auto-callback">Managed transaction (auto-callback)</h2>
<p>Managed transactions handle committing or rolling back the transaction automagically. You start a managed transaction by passing a callback to <code>sequelize.transaction</code>.</p>
<p>Notice how the callback passed to <code>transaction</code> returns a promise chain, and does not explicitly call <code>t.commit()</code> nor <code>t.rollback()</code>. If all promises in the returned chain are resolved successfully the transaction is committed. If one or several of the promises are rejected, the transaction is rolled back.</p>
<pre><code class="lang-js"><span class="hljs-keyword">return</span> sequelize.transaction(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">t</span>) </span>{

  <span class="hljs-comment">// chain all your queries here. make sure you return them.</span>
  <span class="hljs-keyword">return</span> User.create({
    firstName: <span class="hljs-string">&apos;Abraham&apos;</span>,
    lastName: <span class="hljs-string">&apos;Lincoln&apos;</span>
  }, {transaction: t}).then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">user</span>) </span>{
    <span class="hljs-keyword">return</span> user.setShooter({
      firstName: <span class="hljs-string">&apos;John&apos;</span>,
      lastName: <span class="hljs-string">&apos;Boothe&apos;</span>
    }, {transaction: t});
  });

}).then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">result</span>) </span>{
  <span class="hljs-comment">// Transaction has been committed</span>
  <span class="hljs-comment">// result is whatever the result of the promise chain returned to the transaction callback</span>
}).catch(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
  <span class="hljs-comment">// Transaction has been rolled back</span>
  <span class="hljs-comment">// err is whatever rejected the promise chain returned to the transaction callback</span>
});
</code></pre>
<h3 id="throw-errors-to-rollback">Throw errors to rollback</h3>
<p>When using the managed transaction you should <em>never</em> commit or rollback the transaction manually. If all queries are successful, but you still want to rollback the transaction (for example because of a validation failure) you should throw an error to break and reject the chain:</p>
<pre><code class="lang-js"><span class="hljs-keyword">return</span> sequelize.transaction(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">t</span>) </span>{
  <span class="hljs-keyword">return</span> User.create({
    firstName: <span class="hljs-string">&apos;Abraham&apos;</span>,
    lastName: <span class="hljs-string">&apos;Lincoln&apos;</span>
  }, {transaction: t}).then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">user</span>) </span>{
    <span class="hljs-comment">// Woops, the query was successful but we still want to roll back!</span>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>();
  });
});
</code></pre>
<h3 id="automatically-pass-transactions-to-all-queries">Automatically pass transactions to all queries</h3>
<p>In the examples above, the transaction is still manually passed, by passing <code>{ transaction: t }</code> as the second argument. To automatically pass the transaction to all queries you must install the <a href="https://github.com/othiym23/node-continuation-local-storage" target="_blank">continuation local storage</a> (CLS) module and instantiate a namespace in your own code:</p>
<pre><code class="lang-js"><span class="hljs-keyword">const</span> cls = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;continuation-local-storage&apos;</span>),
    namespace = cls.createNamespace(<span class="hljs-string">&apos;my-very-own-namespace&apos;</span>);
</code></pre>
<p>To enable CLS you must tell sequelize which namespace to use by using a static method of the sequelize constructor:</p>
<pre><code class="lang-js"><span class="hljs-keyword">const</span> Sequelize = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;sequelize&apos;</span>);
Sequelize.useCLS(namespace);

<span class="hljs-keyword">new</span> Sequelize(....);
</code></pre>
<p>Notice, that the <code>useCLS()</code> method is on the <em>constructor</em>, not on an instance of sequelize. This means that all instances will share the same namespace, and that CLS is all-or-nothing - you cannot enable it only for some instances.</p>
<p>CLS works like a thread-local storage for callbacks. What this means in practice is that different callback chains can access local variables by using the CLS namespace. When CLS is enabled sequelize will set the <code>transaction</code> property on the namespace when a new transaction is created. Since variables set within a callback chain are private to that chain several concurrent transactions can exist at the same time:</p>
<pre><code class="lang-js">sequelize.transaction(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">t1</span>) </span>{
  namespace.get(<span class="hljs-string">&apos;transaction&apos;</span>) === t1; <span class="hljs-comment">// true</span>
});

sequelize.transaction(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">t2</span>) </span>{
  namespace.get(<span class="hljs-string">&apos;transaction&apos;</span>) === t2; <span class="hljs-comment">// true</span>
});
</code></pre>
<p>In most case you won&apos;t need to access <code>namespace.get(&apos;transaction&apos;)</code> directly, since all queries will automatically look for a transaction on the namespace:</p>
<pre><code class="lang-js">sequelize.transaction(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">t1</span>) </span>{
  <span class="hljs-comment">// With CLS enabled, the user will be created inside the transaction</span>
  <span class="hljs-keyword">return</span> User.create({ name: <span class="hljs-string">&apos;Alice&apos;</span> });
});
</code></pre>
<p>After you&apos;ve used <code>Sequelize.useCLS()</code> all promises returned from sequelize will be patched to maintain CLS context. CLS is a complicated subject - more details in the docs for <a href="https://www.npmjs.com/package/cls-bluebird" target="_blank">cls-bluebird</a>, the patch used to make bluebird promises work with CLS.</p>
<h2 id="concurrentpartial-transactions">Concurrent/Partial transactions</h2>
<p>You can have concurrent transactions within a sequence of queries or have some of them excluded from any transactions. Use the <code>{transaction: }</code> option to control which transaction a query belong to:</p>
<h3 id="without-cls-enabled">Without CLS enabled</h3>
<pre><code class="lang-js">sequelize.transaction(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">t1</span>) </span>{
  <span class="hljs-keyword">return</span> sequelize.transaction(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">t2</span>) </span>{
    <span class="hljs-comment">// With CLS enable, queries here will by default use t2</span>
    <span class="hljs-comment">// Pass in the `transaction` option to define/alter the transaction they belong to.</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.all([
        User.create({ name: <span class="hljs-string">&apos;Bob&apos;</span> }, { transaction: <span class="hljs-literal">null</span> }),
        User.create({ name: <span class="hljs-string">&apos;Mallory&apos;</span> }, { transaction: t1 }),
        User.create({ name: <span class="hljs-string">&apos;John&apos;</span> }) <span class="hljs-comment">// this would default to t2</span>
    ]);
  });
});
</code></pre>
<h2 id="isolation-levels">Isolation levels</h2>
<p>The possible isolations levels to use when starting a transaction:</p>
<pre><code class="lang-js">Sequelize.Transaction.ISOLATION_LEVELS.READ_UNCOMMITTED <span class="hljs-comment">// &quot;READ UNCOMMITTED&quot;</span>
Sequelize.Transaction.ISOLATION_LEVELS.READ_COMMITTED <span class="hljs-comment">// &quot;READ COMMITTED&quot;</span>
Sequelize.Transaction.ISOLATION_LEVELS.REPEATABLE_READ  <span class="hljs-comment">// &quot;REPEATABLE READ&quot;</span>
Sequelize.Transaction.ISOLATION_LEVELS.SERIALIZABLE <span class="hljs-comment">// &quot;SERIALIZABLE&quot;</span>
</code></pre>
<p>By default, sequelize uses the isolation level of the database. If you want to use a different isolation level, pass in the desired level as the first argument:</p>
<pre><code class="lang-js"><span class="hljs-keyword">return</span> sequelize.transaction({
  isolationLevel: Sequelize.Transaction.ISOLATION_LEVELS.SERIALIZABLE
  }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">t</span>) </span>{

  <span class="hljs-comment">// your transactions</span>

  });
</code></pre>
<p>Note: The SET ISOLATION LEVEL queries are not logged in case of MSSQL as the specified isolationLevel is passed directly to tedious</p>
<h2 id="unmanaged-transaction-then-callback">Unmanaged transaction (then-callback)</h2>
<p>Unmanaged transactions force you to manually rollback or commit the transaction. If you don&apos;t do that, the transaction will hang until it times out. To start an unmanaged transaction, call <code>sequelize.transaction()</code> without a callback (you can still pass an options object) and call <code>then</code> on the returned promise. Notice that <code>commit()</code> and <code>rollback()</code> returns a promise.</p>
<pre><code class="lang-js"><span class="hljs-keyword">return</span> sequelize.transaction().then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">t</span>) </span>{
  <span class="hljs-keyword">return</span> User.create({
    firstName: <span class="hljs-string">&apos;Homer&apos;</span>,
    lastName: <span class="hljs-string">&apos;Simpson&apos;</span>
  }, {transaction: t}).then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">user</span>) </span>{
    <span class="hljs-keyword">return</span> user.addSibling({
      firstName: <span class="hljs-string">&apos;Lisa&apos;</span>,
      lastName: <span class="hljs-string">&apos;Simpson&apos;</span>
    }, {transaction: t});
  }).then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> t.commit();
  }).catch(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
    <span class="hljs-keyword">return</span> t.rollback();
  });
});
</code></pre>
<h2 id="options">Options</h2>
<p>The <code>transaction</code> method can be called with an options object as the first argument, that
allows the configuration of the transaction.</p>
<pre><code class="lang-js"><span class="hljs-keyword">return</span> sequelize.transaction({ <span class="hljs-comment">/* options */</span> });
</code></pre>
<p>The following options (with it&apos;s default values) are available:</p>
<pre><code class="lang-js">{
  autocommit: <span class="hljs-literal">true</span>,
  isolationLevel: <span class="hljs-string">&apos;REPEATABLE_READ&apos;</span>,
  deferrable: <span class="hljs-string">&apos;NOT DEFERRABLE&apos;</span> <span class="hljs-comment">// implicit default of postgres</span>
}
</code></pre>
<p>The <code>isolationLevel</code> can either be set globally when initializing the Sequelize instance or
locally for every transaction:</p>
<pre><code class="lang-js"><span class="hljs-comment">// globally</span>
<span class="hljs-keyword">new</span> Sequelize(<span class="hljs-string">&apos;db&apos;</span>, <span class="hljs-string">&apos;user&apos;</span>, <span class="hljs-string">&apos;pw&apos;</span>, {
  isolationLevel: Sequelize.Transaction.ISOLATION_LEVELS.SERIALIZABLE
});

<span class="hljs-comment">// locally</span>
sequelize.transaction({
  isolationLevel: Sequelize.Transaction.ISOLATION_LEVELS.SERIALIZABLE
});
</code></pre>
<p>The <code>deferrable</code> option triggers an additional query after the transaction start
that optionally set the constraint checks to be deferred or immediate. Please note
that this is only supported in PostgreSQL.</p>
<pre><code class="lang-js">sequelize.transaction({
  <span class="hljs-comment">// to defer all constraints:</span>
  deferrable: Sequelize.Deferrable.SET_DEFERRED,

  <span class="hljs-comment">// to defer a specific constraint:</span>
  deferrable: Sequelize.Deferrable.SET_DEFERRED([<span class="hljs-string">&apos;some_constraint&apos;</span>]),

  <span class="hljs-comment">// to not defer constraints:</span>
  deferrable: Sequelize.Deferrable.SET_IMMEDIATE
})
</code></pre>
<h2 id="usage-with-other-sequelize-methods">Usage with other sequelize methods</h2>
<p>The <code>transaction</code> option goes with most other options, which are usually the first argument of a method.
For methods that take values, like <code>.create</code>, <code>.update()</code>, <code>.updateAttributes()</code> etc. <code>transaction</code> should be passed to the option in the second argument.
If unsure, refer to the API documentation for the method you are using to be sure of the signature.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="scopes.html" class="navigation navigation-prev " aria-label="Previous page: scopes">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="upgrade-to-v4.html" class="navigation navigation-next " aria-label="Next page: upgrade to v4">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"transactions","level":"1.15","depth":1,"next":{"title":"upgrade to v4","level":"1.16","depth":1,"path":"docs/upgrade-to-v4.md","ref":"./docs/upgrade-to-v4.md","articles":[]},"previous":{"title":"scopes","level":"1.14","depth":1,"path":"docs/scopes.md","ref":"./docs/scopes.md","articles":[]},"dir":"ltr"},"config":{"plugins":["-lunr","-search","search-plus"],"root":"en-US","styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"search-plus":{},"highlight":{},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{"version":"1.0.0"},"title":"test search plus plugin","gitbook":"*"},"file":{"path":"docs/transactions.md","mtime":"2017-09-07T05:58:40.000Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2017-09-07T12:46:25.859Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search-plus/jquery.mark.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search-plus/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

